name: 🚀 Deploy Credit Risk App to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ⬇️ Checkout code
      uses: actions/checkout@v3

    - name: 🔐 Set up SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: 🚀 Deploy to EC2
      run: |
        ssh -tt -o StrictHostKeyChecking=no deploy@13.42.17.17 <<EOF
        cd /home/deploy

        # Install git if missing
        if ! command -v git &> /dev/null; then
          sudo yum install -y git
        fi

        # Clone repo if not exists
        if [ ! -d "Credit_Risk_Modelling" ]; then
          git clone https://github.com/VatsalSangani/Credit_Risk_Modelling.git
        fi

        cd Credit_Risk_Modelling/credit-risk

        # Pull latest changes
        git pull origin main

        # Stop and remove old container if exists
        docker stop credit-app 2>/dev/null || true
        docker rm credit-app 2>/dev/null || true

        # Remove old image if exists
        docker rmi -f credit-risk-ui:latest 2>/dev/null || true

        # Rebuild and run container
        docker build -t credit-risk-ui .
        docker run -d -p 8000:8000 -p 8501:8501 --name credit-app credit-risk-ui
        EOF
